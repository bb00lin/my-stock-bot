name: Run STM32 GPIO Planner

on:
  workflow_dispatch:  # å…è¨±æ‰‹å‹•é»æ“ŠæŒ‰éˆ•åŸ·è¡Œ
  push:
    paths:
      - '**.py'       # ç•¶ä»»ä½• Python æª”æ¡ˆæ›´æ–°æ™‚è‡ªå‹•åŸ·è¡Œ
      - '**.xml'      # ç•¶ XML æª”æ¡ˆæ›´æ–°æ™‚è‡ªå‹•åŸ·è¡Œ

jobs:
  run-planner:
    runs-on: ubuntu-latest
    timeout-minutes: 5  # è¨­å®šè¶…æ™‚ï¼Œé˜²æ­¢å¡ä½è¶…é 5 åˆ†é˜

    steps:
      # 1. ä¸‹è¼‰å€‰åº«ä¸­çš„æ‰€æœ‰æª”æ¡ˆåˆ°è™›æ“¬æ©Ÿ
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. è¨­å®š Python ç’°å¢ƒ (3.9)
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      # 3. å®‰è£ Python å¥—ä»¶
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install gspread oauth2client

      # 4. (é™¤éŒ¯ç”¨) æª¢æŸ¥æª”æ¡ˆæ˜¯å¦çœŸçš„å­˜åœ¨
      # é€™ä¸€æ­¥æœƒåˆ—å‡ºæ‰€æœ‰æª”æ¡ˆï¼Œå¦‚æœ XML ä¸è¦‹äº†æœƒå ±éŒ¯åœæ­¢
      - name: Check Files Existence
        run: |
          echo "ğŸ“‚ Listing files in current directory:"
          ls -l
          if [ ! -f "STM32MP133CAFx.xml" ]; then
            echo "âŒ éŒ¯èª¤: æ‰¾ä¸åˆ° STM32MP133CAFx.xml æª”æ¡ˆï¼è«‹ç¢ºèªå·²ä¸Šå‚³åˆ° GitHubã€‚"
            exit 1
          fi

      # 5. åŸ·è¡Œä¸»ç¨‹å¼
      # âš ï¸ è«‹ç¢ºèªæ‚¨çš„ Python æª”åæ˜¯å¦ç‚º main.py
      # å¦‚æœæ‚¨çš„æª”åæ˜¯ stm32_dashboard_v4.pyï¼Œè«‹ä¿®æ”¹ä¸‹æ–¹æŒ‡ä»¤
      - name: Run Planner Script
        env:
          GOOGLE_SHEETS_JSON: ${{ secrets.GOOGLE_SHEETS_JSON }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}  # å¦‚æœæœ‰å¯„ä¿¡éœ€æ±‚
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}  # å¦‚æœæœ‰å¯„ä¿¡éœ€æ±‚
        run: stm32_dashboard_v4.py
